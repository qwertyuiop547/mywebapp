{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Overview - Barangay Burgos{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), 
                    url('{% static "images/474106523_917891393848174_7194567452072847933_n.jpg" %}') center center !important;
        background-size: cover !important;
        background-attachment: fixed !important;
        background-repeat: no-repeat !important;
        min-height: 100vh !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .main-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .header-title {
        font-size: 2.2rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .header-subtitle {
        opacity: 0.9;
        margin-bottom: 0;
        font-size: 1.1rem;
    }
    
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .metric-card.complaints { border-left-color: #e74c3c; }
    .metric-card.feedback { border-left-color: #3498db; }
    .metric-card.users { border-left-color: #f39c12; }
    .metric-card.resolutions { border-left-color: #27ae60; }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .metric-label {
        font-size: 1rem;
        color: #7f8c8d;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .trend-info {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .trend-up {
        background: #d4edda;
        color: #155724;
    }
    
    .trend-down {
        background: #f8d7da;
        color: #721c24;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        margin-bottom: 25px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .card-header-analytics {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 20px;
        font-weight: 600;
        font-size: 1.1rem;
        color: #2c3e50;
    }
    
    .card-body-analytics {
        padding: 25px;
    }
    
    .filter-dropdown {
        background: white;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 8px 15px;
        color: #2c3e50;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .filter-dropdown:hover {
        background: #3498db;
        color: white;
    }
    
    .export-btn {
        background: #27ae60;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .export-btn:hover {
        background: #219a52;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .period-selector {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .period-btn {
        background: transparent;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 8px 15px;
        margin: 0 5px;
        color: #666;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .period-btn.active,
    .period-btn:hover {
        border-color: #3498db;
        background: #3498db;
        color: white;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .header-title {
            font-size: 1.8rem;
        }
        
        .metric-value {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Main Header -->
    <div class="main-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="header-title">
                    <i class="fas fa-chart-line me-3"></i>Analytics Overview
                </h1>
                <p class="header-subtitle">Barangay Performance & Community Insights</p>
            </div>
            <div class="col-lg-4 text-end">
                <div class="d-flex align-items-center justify-content-end gap-3">
                    <div class="dropdown">
                        <button class="filter-dropdown dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-calendar me-2"></i>Last {{ selected_days|default:"30" }} days
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?days=7">Last 7 days</a></li>
                            <li><a class="dropdown-item" href="?days=30">Last 30 days</a></li>
                            <li><a class="dropdown-item" href="?days=90">Last 90 days</a></li>
                            <li><a class="dropdown-item" href="?days=365">Last year</a></li>
                        </ul>
                    </div>
                    <a href="{% url 'analytics:export' %}?type=overview" class="export-btn">
                        <i class="fas fa-download me-2"></i>Export Data
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="metric-card complaints">
            <div class="metric-value">{{ stats.total_complaints|default:"47" }}</div>
            <div class="metric-label">Total Complaints</div>
            <span class="trend-info trend-up">
                <i class="fas fa-arrow-up me-1"></i>+{{ recent_complaints|default:"3" }} recent
            </span>
        </div>
        
        <div class="metric-card feedback">
            <div class="metric-value">{{ stats.total_feedback|default:"128" }}</div>
            <div class="metric-label">Community Feedback</div>
            <span class="trend-info trend-up">
                <i class="fas fa-arrow-up me-1"></i>+{{ recent_feedback|default:"8" }} recent
            </span>
        </div>
        
        <div class="metric-card users">
            <div class="metric-value">{{ stats.total_users|default:"245" }}</div>
            <div class="metric-label">Registered Users</div>
            <span class="trend-info trend-up">
                <i class="fas fa-arrow-up me-1"></i>+{{ recent_users|default:"5" }} new
            </span>
        </div>
        
        <div class="metric-card resolutions">
            <div class="metric-value">{{ stats.resolved_complaints|default:"39" }}%</div>
            <div class="metric-label">Resolution Rate</div>
            <span class="trend-info trend-up">
                <i class="fas fa-arrow-up me-1"></i>+{{ resolution_improvement|default:"2" }}% improvement
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Charts Column -->
        <div class="col-lg-8">
            <!-- Monthly Trends Chart -->
            <div class="chart-card">
                <div class="card-header-analytics">
                    <i class="fas fa-line-chart me-2"></i>Monthly Trends
                </div>
                <div class="card-body-analytics">
                    <canvas id="monthlyTrendsChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Complaint Status Distribution -->
            <div class="chart-card">
                <div class="card-header-analytics">
                    <i class="fas fa-pie-chart me-2"></i>Complaint Status Distribution
                </div>
                <div class="card-body-analytics">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="complaintStatusChart" width="200" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Pending</span>
                                    <strong>{{ complaint_stats.pending|default:"8" }}</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">In Progress</span>
                                    <strong>{{ complaint_stats.in_progress|default:"15" }}</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Resolved</span>
                                    <strong>{{ complaint_stats.resolved|default:"20" }}</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Closed</span>
                                    <strong>{{ complaint_stats.closed|default:"4" }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Sidebar -->
        <div class="col-lg-4">
            <!-- Performance Metrics -->
            <div class="chart-card">
                <div class="card-header-analytics">
                    <i class="fas fa-tachometer-alt me-2"></i>Performance Metrics
                </div>
                <div class="card-body-analytics">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Avg. Response Time</span>
                            <strong>{{ avg_response_time|default:"2.5" }} hours</strong>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: 85%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Resolution Efficiency</span>
                            <strong>{{ resolution_efficiency|default:"78" }}%</strong>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: 78%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Community Satisfaction</span>
                            <strong>{{ satisfaction_rating|default:"4.2" }}/5.0</strong>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: 84%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Categories -->
            <div class="chart-card">
                <div class="card-header-analytics">
                    <i class="fas fa-tags me-2"></i>Top Complaint Categories
                </div>
                <div class="card-body-analytics">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Infrastructure</span>
                            <span class="badge bg-danger">{{ top_categories.infrastructure|default:"18" }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Public Safety</span>
                            <span class="badge bg-warning">{{ top_categories.safety|default:"12" }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Utilities</span>
                            <span class="badge bg-info">{{ top_categories.utilities|default:"9" }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Environment</span>
                            <span class="badge bg-success">{{ top_categories.environment|default:"8" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Summary -->
            <div class="chart-card">
                <div class="card-header-analytics">
                    <i class="fas fa-clock me-2"></i>Recent Activity Summary
                </div>
                <div class="card-body-analytics">
                    <small class="text-muted d-block mb-2">Last 24 hours</small>
                    <div class="mb-2">
                        <strong>{{ activity.new_complaints|default:"3" }}</strong> new complaints filed
                    </div>
                    <div class="mb-2">
                        <strong>{{ activity.resolved|default:"5" }}</strong> complaints resolved
                    </div>
                    <div class="mb-2">
                        <strong>{{ activity.feedback_received|default:"7" }}</strong> feedback submissions
                    </div>
                    <div class="mb-2">
                        <strong>{{ activity.new_users|default:"2" }}</strong> new user registrations
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Monthly Trends Chart
const ctx1 = document.getElementById('monthlyTrendsChart').getContext('2d');
const monthlyTrendsChart = new Chart(ctx1, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
        datasets: [{
            label: 'Complaints',
            data: {{ monthly_complaints|default:"[12, 15, 8, 20, 14, 18, 22, 16, 13]"|safe }},
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 3,
            fill: true
        }, {
            label: 'Resolutions',
            data: {{ monthly_resolutions|default:"[10, 13, 9, 18, 12, 16, 19, 14, 12]"|safe }},
            borderColor: '#27ae60',
            backgroundColor: 'rgba(39, 174, 96, 0.1)',
            borderWidth: 3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Complaint Status Pie Chart
const ctx2 = document.getElementById('complaintStatusChart').getContext('2d');
const complaintStatusChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
        labels: ['Pending', 'In Progress', 'Resolved', 'Closed'],
        datasets: [{
            data: [
                {{ complaint_stats.pending|default:"8" }},
                {{ complaint_stats.in_progress|default:"15" }},
                {{ complaint_stats.resolved|default:"20" }},
                {{ complaint_stats.closed|default:"4" }}
            ],
            backgroundColor: [
                '#f39c12',
                '#3498db',
                '#27ae60',
                '#95a5a6'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});
</script>
                        </small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card residents">
                        <div class="metric-value">{{ stats.total_residents }}</div>
                        <div class="metric-label">Active Residents</div>
                        {% if stats.pending_approvals > 0 %}
                            <small class="trend-info">
                                <i class="fas fa-clock text-warning"></i> {{ stats.pending_approvals }} pending approval
                            </small>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card resolution">
                        <div class="metric-value">{{ avg_resolution_days }}</div>
                        <div class="metric-label">Avg Resolution Days</div>
                        <small class="trend-info">
                            <i class="fas fa-clock"></i> Average time to resolve
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Monthly Trends -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> Monthly Complaint Trends</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="monthlyTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Distribution -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-pie"></i> Status Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Priority and Category Analysis -->
            <div class="row mb-4">
                <!-- Priority Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-exclamation-triangle"></i> Priority Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="priorityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Category Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-tags"></i> Top Categories</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-analytics">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in category_stats %}
                                            <tr>
                                                <td>{{ category.name }}</td>
                                                <td>{{ category.complaint_count }}</td>
                                                <td>
                                                    {% widthratio category.complaint_count stats.total_complaints 100 as percentage %}
                                                    <div class="progress progress-small">
                                                        <div class="progress-bar" role="progressbar" title="{{ category.name }} - {{ percentage }}%" data-width="{{ percentage }}%"></div>
                                                    </div>
                                                    <small>{{ percentage }}%</small>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Complainants and Feedback Stats -->
            <div class="row mb-4">
                <!-- Top Complainants -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-users"></i> Most Active Complainants</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-analytics">
                                    <thead>
                                        <tr>
                                            <th>Resident</th>
                                            <th>Complaints</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for complainant in top_complainants %}
                                            <tr>
                                                <td>
                                                    {{ complainant.first_name }} {{ complainant.last_name|default:complainant.username }}
                                                </td>
                                                <td>
                                                    <span class="badge bg-primary">{{ complainant.complaint_count }}</span>
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="2" class="text-center text-muted">No data available</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feedback Summary -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-star"></i> Feedback Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <h3 class="text-primary">{{ feedback_stats.total }}</h3>
                                    <p class="text-muted mb-0">Total Feedback</p>
                                </div>
                                <div class="col-4">
                                    <h3 class="text-success">{{ feedback_stats.avg_rating|floatformat:1 }}</h3>
                                    <p class="text-muted mb-0">Avg Rating</p>
                                    <div class="text-warning">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= feedback_stats.avg_rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-4">
                                    <h3 class="text-info">{{ feedback_stats.with_response }}</h3>
                                    <p class="text-muted mb-0">Responded</p>
                                    {% if feedback_stats.total > 0 %}
                                        {% widthratio feedback_stats.with_response feedback_stats.total 100 as response_rate %}
                                        <small class="text-muted">{{ response_rate }}% response rate</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <a href="{% url 'analytics:complaints' %}" class="btn btn-outline-primary btn-lg btn-block w-100">
                                        <i class="fas fa-chart-bar"></i><br>
                                        Detailed Complaint Analytics
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'analytics:feedback' %}" class="btn btn-outline-info btn-lg btn-block w-100">
                                        <i class="fas fa-chart-line"></i><br>
                                        Feedback Analytics
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'complaints:list' %}" class="btn btn-outline-warning btn-lg btn-block w-100">
                                        <i class="fas fa-list"></i><br>
                                        View All Complaints
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'feedback:list' %}" class="btn btn-outline-success btn-lg btn-block w-100">
                                        <i class="fas fa-comments"></i><br>
                                        View All Feedback
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Set progress bar widths on page load
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar[data-width]');
    progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        bar.style.width = width;
    });
});

// Monthly Trends Chart
const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
const monthlyData = {{ monthly_data|safe }};

new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: monthlyData.map(item => item.month),
        datasets: [{
            label: 'Complaints',
            data: monthlyData.map(item => item.complaints),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Status Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Pending', 'In Progress', 'Resolved', 'Closed'],
        datasets: [{
            data: [
                {{ complaint_stats.pending }},
                {{ complaint_stats.in_progress }},
                {{ complaint_stats.resolved }},
                {{ complaint_stats.closed }}
            ],
            backgroundColor: [
                '#ffc107',
                '#17a2b8',
                '#28a745',
                '#6c757d'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Priority Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: ['Low', 'Medium', 'High', 'Urgent'],
        datasets: [{
            data: [
                {{ priority_stats.low }},
                {{ priority_stats.medium }},
                {{ priority_stats.high }},
                {{ priority_stats.urgent }}
            ],
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#fd7e14',
                '#dc3545'
            ],
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}