{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ complaint.title }} - Barangay Burgos{% endblock %}

{% block extra_css %}
<style>
    /* Official Philippine Government Portal Theme - Matching Resident Dashboard */
    :root {
        --ph-blue: #0038a8;
        --ph-red: #ce1126;
        --ph-yellow: #fcd116;
        --ph-white: #ffffff;
        --gov-primary: #003f7f;
        --gov-secondary: #ffd700;
        --gov-accent: #dc3545;
        --gov-success: #28a745;
        --gov-warning: #ffc107;
        --gov-info: #17a2b8;
        --gov-light: #f8f9fa;
        --gov-dark: #212529;
        --gov-gradient: linear-gradient(135deg, var(--ph-blue) 0%, #1e5799 50%, #2989d8 100%);
        --shadow-light: 0 2px 8px rgba(0,56,168,0.15);
        --shadow-medium: 0 4px 16px rgba(0,56,168,0.2);
        --shadow-heavy: 0 8px 32px rgba(0,56,168,0.3);
        --border-radius: 8px;
    }
    
    /* Modal fixes to prevent freezing */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5) !important;
        z-index: 1040 !important;
    }
    
    .modal {
        z-index: 1050 !important;
    }
    
    .modal-content {
        border: none;
        box-shadow: var(--shadow-heavy);
        border-radius: var(--border-radius);
    }
    
    .modal-header.bg-warning {
        border-bottom: 2px solid #f0ad4e;
    }
    
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    
    /* Ensure buttons are always clickable */
    .btn {
        position: relative;
        z-index: 1051;
        pointer-events: auto !important;
    }
    
    /* Fix for body when modal is open */
    body.modal-open {
        overflow: hidden !important;
        padding-right: 0 !important;
    }
    
    /* Dashboard Welcome Section Style for Page Header */
    .page-header {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        margin: 25px 0;
        box-shadow: var(--shadow-light);
        border-left: 5px solid var(--ph-blue);
    }
    
    .welcome-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .page-title {
        font-size: 24px;
        color: var(--ph-blue);
        font-weight: 700;
        margin: 0;
    }
    
    .page-subtitle {
        margin: 0;
        color: #666;
        font-size: 14px;
    }
    
    .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .btn-header {
        background: var(--ph-blue);
        color: white;
        padding: 10px 18px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-light);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
    }
    
    .btn-header:hover {
        background: #1e5799;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }
    
    .btn-header.btn-primary {
        background: rgba(40,167,69,0.3);
        border-color: rgba(40,167,69,0.5);
    }
    
    .btn-header.btn-danger {
        background: rgba(220,53,69,0.3);
        border-color: rgba(220,53,69,0.5);
    }
    
    .btn-header.btn-secondary {
        background: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    
    .btn-header.btn-secondary:hover {
        background: #5a6268;
        color: white;
    }
    
    .btn-header.btn-success {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }
    
    .btn-header.btn-success:hover {
        background: #218838;
        color: white;
    }
    
    .btn-header.btn-warning {
        background: #ffc107;
        border-color: #ffc107;
        color: #212529;
    }
    
    .btn-header.btn-warning:hover {
        background: #e0a800;
        color: #212529;
    }
    
    /* Content Sections - Matching Dashboard Cards */
    .detail-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        margin: 20px 0;
        box-shadow: var(--shadow-light);
        border-left: 5px solid var(--ph-blue);
    }
    
    .complaint-header {
        background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .complaint-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--ph-blue);
        margin-bottom: 15px;
    }
    
    .complaint-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0,56,168,0.05);
        padding: 8px 15px;
        border-radius: 20px;
        border: 1px solid rgba(0,56,168,0.1);
    }
    
    .meta-item i {
        color: var(--ph-blue);
    }
    
    /* Status Badges - Matching Dashboard Style */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-pending { 
        background: rgba(255,193,7,0.15);
        color: #856404; 
        border: 1px solid rgba(255,193,7,0.3);
    }
    .status-in_progress { 
        background: rgba(23,162,184,0.15);
        color: #0c5460; 
        border: 1px solid rgba(23,162,184,0.3);
    }
    .status-resolved { 
        background: rgba(40,167,69,0.15);
        color: #155724; 
        border: 1px solid rgba(40,167,69,0.3);
    }
    .status-closed { 
        background: rgba(108,117,125,0.15);
        color: #495057; 
        border: 1px solid rgba(108,117,125,0.3);
    }
    
    .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .priority-low { 
        background: linear-gradient(135deg, #d4edda, #00b894); 
        color: #155724; 
    }
    .priority-medium { 
        background: linear-gradient(135deg, #fff3cd, #fdcb6e); 
        color: #856404; 
    }
    .priority-high { 
        background: linear-gradient(135deg, #f8d7da, #e17055); 
        color: #721c24; 
    }
    .priority-urgent { 
        background: linear-gradient(135deg, #f5c6cb, #d63031); 
        color: #721c24; 
    }
    
    .assignment-info {
        background: rgba(255,255,255,0.15);
        padding: 15px 20px;
        border-radius: 10px;
        margin-top: 20px;
        position: relative;
        z-index: 2;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    .resolution-info {
        background: rgba(40,167,69,0.1);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        border-left: 4px solid #28a745;
    }
    
    .resolution-notes {
        background: rgba(255,255,255,0.5);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }
    
    .resolution-text {
        line-height: 1.6;
        color: #333;
    }
    
    .proof-image-container {
        text-align: center;
    }
    
    .resolution-proof-image {
        transition: transform 0.3s ease;
    }
    
    .resolution-proof-image:hover {
        transform: scale(1.05);
    }
    
    .detail-body {
        padding: 35px;
    }
    
    .section-title {
        color: var(--gov-primary);
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(0,63,127,0.1);
    }
    
    .section-title i {
        color: var(--gov-secondary);
        font-size: 1.1rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .info-item {
        background: rgba(0,63,127,0.05);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--gov-primary);
    }
    
    .info-label {
        font-weight: 600;
        color: var(--gov-primary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .info-value {
        font-size: 1.1rem;
        color: var(--gov-dark);
        font-weight: 500;
    }
    
    .description-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        border-left: 5px solid var(--gov-primary);
        margin: 20px 0;
        line-height: 1.7;
        font-size: 1.05rem;
    }
    
    .attachment-item {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .attachment-item:hover {
        border-color: var(--gov-primary);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,63,127,0.15);
    }
    
    .attachment-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--gov-primary), #2989d8);
        color: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        box-shadow: 0 4px 15px rgba(0,63,127,0.2);
    }
    
    .attachment-info h6 {
        margin: 0 0 8px 0;
        font-weight: 600;
        color: var(--gov-dark);
        font-size: 1.1rem;
    }
    
    .attachment-info small {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .comment-item {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .comment-item:hover {
        border-color: rgba(0,63,127,0.3);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,63,127,0.1);
    }
    
    .internal-comment {
        background: linear-gradient(135deg, #fff8e1, #fff3cd);
        border-color: var(--gov-warning);
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .comment-author {
        font-weight: 600;
        color: var(--gov-primary);
        font-size: 1.1rem;
    }
    
    .comment-date {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .comment-text {
        line-height: 1.7;
        color: var(--gov-dark);
        font-size: 1.05rem;
    }
    
    .comment-form {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid rgba(0,63,127,0.1);
        margin-top: 25px;
    }
    
    .sidebar-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        margin-bottom: 25px;
        overflow: hidden;
    }
    
    .sidebar-header {
        background: linear-gradient(135deg, var(--gov-primary), #2989d8);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .sidebar-body {
        padding: 25px;
    }
    
    /* Workflow Actions - Matching Dashboard Action Cards */
    .workflow-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .btn-workflow {
        background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
        padding: 16px 20px;
        border-radius: var(--border-radius);
        text-decoration: none;
        color: inherit;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-weight: 600;
    }
    
    .btn-workflow:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        text-decoration: none;
        color: inherit;
        border-color: rgba(0,56,168,0.3);
    }
    
    .btn-workflow i {
        font-size: 20px;
        margin-bottom: 5px;
    }
    
    .btn-workflow.btn-primary {
        color: var(--ph-blue);
    }
    
    .btn-workflow.btn-primary:hover {
        color: var(--ph-blue);
        background: rgba(0,56,168,0.05);
    }
    
    .btn-workflow.btn-success {
        color: var(--gov-success);
    }
    
    .btn-workflow.btn-success:hover {
        color: var(--gov-success);
        background: rgba(40,167,69,0.05);
    }
    
    .btn-workflow.btn-warning {
        color: var(--gov-warning);
    }
    
    .btn-workflow.btn-warning:hover {
        color: var(--gov-warning);
        background: rgba(255,193,7,0.05);
    }
    
    .btn-workflow.btn-outline-primary {
        color: var(--ph-blue);
        border-color: var(--ph-blue);
        background: transparent;
    }
    
    .btn-workflow.btn-outline-primary:hover {
        background: var(--ph-blue);
        color: white;
    }
    
    /* Content Sections */
    .content-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        margin: 20px 0;
        box-shadow: var(--shadow-light);
        border-left: 5px solid var(--ph-blue);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--ph-blue);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .btn-workflow.btn-outline-primary:hover {
        background: var(--gov-primary);
        color: white;
    }
    
    .workflow-guide {
        background: rgba(0,63,127,0.05);
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        text-align: center;
    }
    
    .workflow-steps {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    
    .workflow-step {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .workflow-arrow {
        color: var(--gov-primary);
        font-weight: bold;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            text-align: center;
        }
        
        .page-title {
            font-size: 1.8rem;
        }
        
        .complaint-meta {
            justify-content: center;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .detail-body,
        .sidebar-body {
            padding: 25px 20px;
        }
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .attachment-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .attachment-icon {
        width: 40px;
        height: 40px;
        background: #667eea;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .attachment-info h6 {
        margin: 0 0 5px 0;
        font-weight: 500;
    }
    
    .attachment-info small {
        color: #6c757d;
    }
    
    .comment-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .comment-author {
        font-weight: 500;
        color: #495057;
    }
    
    .comment-date {
        color: #6c757d;
        font-size: 0.85rem;
    }
    
    .comment-text {
        line-height: 1.6;
        color: #495057;
    }
    
    .internal-comment {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .comment-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .btn-primary {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    .btn-primary:hover {
        background-color: #5a6fd8;
        border-color: #5a6fd8;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }
    
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    /* Image Gallery Styles */
    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .gallery-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
    }
    
    .gallery-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,56,168,0.15);
    }
    
    .gallery-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .gallery-item:hover .gallery-thumbnail {
        transform: scale(1.05);
    }
    
    .gallery-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,56,168,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        color: white;
        font-size: 1.5rem;
    }
    
    .gallery-item:hover .gallery-overlay {
        opacity: 1;
    }
    
    /* Image Modal Styles */
    .image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .image-modal.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
    }
    
    .modal-image {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 8px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    .modal-close {
        position: absolute;
        top: -40px;
        right: -40px;
        background: var(--ph-blue);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }
    
    .modal-close:hover {
        background: #1e5799;
        transform: scale(1.1);
    }
    
    .modal-caption {
        position: absolute;
        bottom: -50px;
        left: 0;
        right: 0;
        color: white;
        text-align: center;
        font-size: 14px;
    }
    
    @media (max-width: 768px) {
        .image-gallery {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .modal-close {
            top: -30px;
            right: -30px;
            width: 30px;
            height: 30px;
            font-size: 1rem;
        }
        
        .modal-caption {
            bottom: -40px;
            font-size: 12px;
        }
    }
    
    @media (max-width: 768px) {
        .complaint-meta {
            flex-direction: column;
            gap: 10px;
        }
        
        .action-buttons {
            justify-content: center;
        }
        
        .info-row {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Dashboard Welcome Section -->
    <div class="page-header">
        <div class="welcome-header">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-file-alt"></i>
                    Complaint Details
                    {% if complaint.is_approved == False %}
                        <span class="badge bg-danger ms-2">
                            <i class="fas fa-times"></i> Rejected
                        </span>
                    {% elif not complaint.is_approved %}
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="fas fa-clock"></i> Pending Approval
                        </span>
                    {% elif complaint.is_approved %}
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-check"></i> Approved
                        </span>
                    {% endif %}
                </h1>
                <p class="page-subtitle">
                    Complaint #{{ complaint.id }} - {{ complaint.get_status_display }}
                    {% if complaint.approved_by and complaint.approved_at %}
                        <br><small class="text-muted">Approved by {{ complaint.approved_by.get_full_name|default:complaint.approved_by.username }} on {{ complaint.approved_at|date:"M d, Y" }}</small>
                    {% endif %}
                </p>
            </div>
            <div class="header-actions">
                <a href="{% url 'complaints:complaint_list' %}" class="btn-header btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Complaints
                </a>
                
                {% if user.role == 'secretary' and not complaint.is_approved %}
                    <!-- Secretary approval buttons -->
                    <form method="post" action="{% url 'complaints:approve_complaint' complaint.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-header btn-success">
                            <i class="fas fa-check"></i> Approve (Direct)
                        </button>
                    </form>
                    
                    <!-- ZERO JAVASCRIPT REJECT SYSTEM - Pure HTML -->
                    {% if request.GET.show_reject != 'yes' %}
                        <!-- Show reject button -->
                        <a href="?show_reject=yes#reject-section" class="btn-header btn-warning">
                            <i class="fas fa-times"></i> Reject
                        </a>
                    {% else %}
                        <!-- Show cancel button -->
                        <a href="?" class="btn-header btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel Reject
                        </a>
                    {% endif %}
                {% endif %}
                
                <!-- Direct rejection form - No JavaScript at all! -->
                {% if user.role == 'secretary' and not complaint.is_approved and request.GET.show_reject == 'yes' %}
                <div id="reject-section" style="margin-top: 20px; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <h5 style="color: #856404; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> Reject Complaint: "{{ complaint.title }}"
                    </h5>
                    <div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        <strong>⚠️ Warning:</strong> This action will permanently reject this complaint and notify the complainant.
                    </div>
                    
                    <form method="post" action="{% url 'complaints:reject_complaint' complaint.id %}">
                        {% csrf_token %}
                        <div style="margin-bottom: 20px;">
                            <label for="rejectionReason" style="font-weight: bold; margin-bottom: 8px; display: block; color: #495057;">
                                Reason for Rejection <span style="color: #dc3545;">*</span>
                            </label>
                            <textarea id="rejectionReason" name="rejection_reason" rows="5" required 
                                    placeholder="Please provide a detailed reason for rejecting this complaint. This message will be sent to the complainant."
                                    style="width: 100%; padding: 15px; border: 2px solid #ced4da; border-radius: 8px; font-family: inherit; resize: vertical; font-size: 14px; line-height: 1.5;">{{ request.POST.rejection_reason }}</textarea>
                            <small style="color: #6c757d; font-size: 0.875em; margin-top: 5px; display: block;">
                                <i class="fas fa-info-circle"></i> This reason will be shared with the complainant via email.
                            </small>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: flex-end; align-items: center;">
                            <a href="?" style="background: #6c757d; color: white; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 500;">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                <i class="fas fa-ban"></i> Reject This Complaint
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
                
                {% comment %} Only Chairman and Admin can update/delete complaints, NOT Secretary {% endcomment %}
                {% if user.can_manage_complaints and complaint.is_approved %}
                    {% if user.role == 'chairman' or user.is_superuser %}
                        <a href="{% url 'complaints:update_complaint' complaint.id %}" class="btn-header btn-primary">
                            <i class="fas fa-edit"></i> Update
                        </a>
                        {% if complaint.status == 'resolved' or complaint.status == 'closed' %}
                            <button type="button" class="btn-header btn-danger delete-btn" data-complaint-id="{{ complaint.id }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Main Complaint Details -->
            <div class="detail-container">
                <div class="complaint-header">
                    <div class="complaint-title">{{ complaint.title }}</div>
                    
                    <div class="complaint-meta">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            {% if complaint.is_anonymous %}
                                <span class="text-muted">
                                    <i class="fas fa-user-secret me-1"></i>Anonymous Complaint
                                </span>
                            {% else %}
                                {{ complaint.complainant.get_full_name|default:complaint.complainant.username }}
                            {% endif %}
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            {{ complaint.created_at|date:"M d, Y g:i A" }}
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-tag"></i>
                            {{ complaint.category.name }}
                        </div>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-3 mb-3">
                        <span class="status-badge status-{{ complaint.status }}">
                            <i class="fas fa-{% if complaint.status == 'pending' %}clock{% elif complaint.status == 'in_progress' %}cog{% elif complaint.status == 'resolved' %}check{% else %}times{% endif %}"></i>
                            {{ complaint.get_status_display }}
                        </span>
                        <span class="priority-badge priority-{{ complaint.priority }}">
                            <i class="fas fa-{% if complaint.priority == 'urgent' %}exclamation-triangle{% elif complaint.priority == 'high' %}exclamation-circle{% elif complaint.priority == 'medium' %}flag{% else %}info-circle{% endif %}"></i>
                            {{ complaint.get_priority_display }}
                        </span>
                    </div>
                    
                    <!-- Rejection Notice - Show to residents when complaint is rejected -->
                    {% if complaint.is_approved == False and complaint.rejection_reason %}
                    <div class="alert alert-danger mt-3" style="border-left: 5px solid #dc3545;">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-times-circle text-danger me-3" style="font-size: 1.5rem; margin-top: 2px;"></i>
                            <div class="flex-grow-1">
                                <h5 class="alert-heading mb-2">
                                    <strong>Complaint Rejected</strong>
                                </h5>
                                <p class="mb-2">
                                    Your complaint has been reviewed and rejected by the Barangay Secretary on {{ complaint.approved_at|date:"F d, Y \a\t g:i A" }}.
                                </p>
                                <hr class="my-3">
                                <div>
                                    <strong class="text-danger">Reason for Rejection:</strong>
                                    <div class="mt-2 p-3" style="background: rgba(220,53,69,0.1); border-radius: 8px; border-left: 3px solid #dc3545;">
                                        {{ complaint.rejection_reason|linebreaks }}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        You may submit a new complaint addressing the concerns mentioned above.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Assignment Information -->
                    {% if complaint.assigned_to %}
                    <div class="assignment-info">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="fas fa-user-shield"></i>
                            <strong>Assigned to: {{ complaint.assigned_to.get_full_name }} ({{ complaint.assigned_to.get_role_display }})</strong>
                        </div>
                        {% if complaint.assigned_at %}
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-clock"></i>
                                Assigned on {{ complaint.assigned_at|date:"M d, Y g:i A" }}
                            </div>
                        {% endif %}
                        {% if complaint.response_due %}
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-bell"></i>
                                Response due: {{ complaint.response_due|date:"M d, Y g:i A" }}
                            </div>
                        {% endif %}
                        {% if complaint.assignment_notes %}
                            <div class="mt-3">
                                <i class="fas fa-sticky-note"></i>
                                <em>{{ complaint.assignment_notes }}</em>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Resolved Information -->
                    {% if complaint.resolved_at %}
                    <div class="resolution-info">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <i class="fas fa-check-circle text-success"></i>
                            <strong>Resolved on {{ complaint.resolved_at|date:"F d, Y \a\t g:i A" }}</strong>
                            {% if complaint.resolved_by %}
                                <span class="text-muted">by {{ complaint.resolved_by.get_full_name|default:complaint.resolved_by.username }}</span>
                            {% endif %}
                        </div>
                        
                        {% if complaint.resolution_notes %}
                        <div class="resolution-notes mb-3">
                            <h6 class="text-success mb-2">
                                <i class="fas fa-sticky-note"></i> Resolution Notes
                            </h6>
                            <div class="resolution-text">
                                {{ complaint.resolution_notes|linebreaks }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if complaint.resolution_proof %}
                        <div class="resolution-proof">
                            <h6 class="text-success mb-2">
                                <i class="fas fa-camera"></i> Resolution Proof
                            </h6>
                            {% if complaint.resolution_proof.name|lower|slice:"-4:" in "jpg,jpeg,png,gif,webp" or complaint.resolution_proof.name|lower|slice:"-5:" in "webp" %}
                                <!-- Image proof -->
                                <div class="proof-image-container">
                                    <div onclick="viewImage('{{ complaint.resolution_proof.url }}', 'Resolution Proof')" style="cursor: pointer; display: block;">
                                        <img src="{{ complaint.resolution_proof.url }}" 
                                             alt="Resolution Proof"
                                             class="resolution-proof-image"
                                             title="Click to view full size"
                                             style="max-width: 300px; max-height: 200px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    </div>
                                    <p class="small text-muted mt-2">Click image to view full size</p>
                                </div>
                            {% else %}
                                <!-- Document proof -->
                                <div class="proof-document">
                                    <a href="{{ complaint.resolution_proof.url }}" target="_blank" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-download"></i> View Resolution Document
                                    </a>
                                    <p class="small text-muted mt-1">{{ complaint.resolution_proof.name }}</p>
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="detail-body">
                    <!-- Description -->
                    <div class="mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-file-text"></i>
                            Description
                        </h5>
                        <div class="description-section">
                            {{ complaint.description|linebreaks }}
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </h5>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Priority</div>
                                <div class="info-value">{{ complaint.get_priority_display }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Status</div>
                                <div class="info-value">{{ complaint.get_status_display }}</div>
                            </div>
                            {% if complaint.location %}
                            <div class="info-item">
                                <div class="info-label">Location</div>
                                <div class="info-value">{{ complaint.location }}</div>
                            </div>
                            {% endif %}
                            {% if complaint.assigned_to %}
                            <div class="info-item">
                                <div class="info-label">Assigned to</div>
                                <div class="info-value">{{ complaint.assigned_to.get_full_name|default:complaint.assigned_to.username }}</div>
                            </div>
                            {% endif %}
                            <div class="info-item">
                                <div class="info-label">Created</div>
                                <div class="info-value">{{ complaint.created_at|date:"F d, Y g:i A" }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Last Updated</div>
                                <div class="info-value">{{ complaint.updated_at|date:"F d, Y g:i A" }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Attachments -->
                    {% if attachments %}
                    <div class="mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-paperclip"></i>
                            Attachments ({{ attachments.count }})
                        </h5>
                        
                        <!-- Image Gallery Section -->
                        {% regroup attachments by file_type as grouped_attachments %}
                        {% for group in grouped_attachments %}
                            {% if group.grouper == 'image' %}
                                <div class="mb-3">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-images"></i> Photos
                                    </h6>
                                    <div class="image-gallery">
                                        {% for attachment in group.list %}
                                            <div class="gallery-item">
                                                <div onclick="viewImage('{{ attachment.file.url }}', '{{ attachment.file_name }}')" 
                                                     style="cursor: pointer; display: block;" 
                                                     title="Click to view: {{ attachment.file_name }}">
                                                    <img src="{{ attachment.file.url }}" 
                                                         alt="{{ attachment.file_name }}"
                                                         class="gallery-thumbnail"
                                                         title="Click to view full size: {{ attachment.file_name }}"
                                                         style="cursor: pointer; width: 100%; height: 100%; object-fit: cover;">
                                                    <div class="gallery-overlay">
                                                        <i class="fas fa-search-plus"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Other Files Section -->
                        {% for group in grouped_attachments %}
                            {% if group.grouper != 'image' %}
                                <div class="mb-3">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-file"></i> Other Files
                                    </h6>
                                    {% for attachment in group.list %}
                                        <div class="attachment-item">
                                            <div class="attachment-icon">
                                                {% if attachment.file_type == 'video' %}
                                                    <i class="fas fa-video"></i>
                                                {% else %}
                                                    <i class="fas fa-file"></i>
                                                {% endif %}
                                            </div>
                                            <div class="attachment-info flex-grow-1">
                                                <h6>{{ attachment.file_name }}</h6>
                                                <small>Uploaded {{ attachment.uploaded_at|date:"M d, Y g:i A" }}</small>
                                            </div>
                                            <div>
                                                <a href="{{ attachment.file.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                                    <i class="fas fa-download"></i> Download
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Comments Section -->
            <div class="detail-container fade-in">
                <div class="detail-body">
                    <h5 class="section-title">
                        <i class="fas fa-comments"></i>
                        Comments & Updates ({{ comments.count }})
                    </h5>

                    <!-- Existing Comments -->
                    {% for comment in comments %}
                    <div class="comment-item {% if comment.is_internal %}internal-comment{% endif %}">
                        <div class="comment-header">
                            <div class="comment-author">
                                {{ comment.author.get_full_name|default:comment.author.username }}
                                {% if comment.is_internal %}
                                    <span class="badge bg-warning ms-2">Internal</span>
                                {% endif %}
                            </div>
                            <div class="comment-date">{{ comment.created_at|date:"M d, Y g:i A" }}</div>
                        </div>
                        <div class="comment-text">{{ comment.comment|linebreaks }}</div>
                        {% if comment.attachment %}
                        <div class="comment-attachment mt-2">
                            <div class="attachment-info">
                                <i class="fas fa-paperclip text-primary"></i>
                                <a href="{{ comment.attachment.url }}" target="_blank" class="attachment-link">
                                    {% if comment.attachment.name|slice:"-4:" == ".jpg" or comment.attachment.name|slice:"-4:" == ".png" or comment.attachment.name|slice:"-4:" == ".gif" or comment.attachment.name|slice:"-5:" == ".jpeg" %}
                                        <i class="fas fa-image"></i> View Image
                                    {% elif comment.attachment.name|slice:"-4:" == ".pdf" %}
                                        <i class="fas fa-file-pdf"></i> View PDF
                                    {% else %}
                                        <i class="fas fa-file"></i> Download File
                                    {% endif %}
                                </a>
                                <small class="text-muted ms-2">({{ comment.attachment.name|truncatechars:30 }})</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments-slash text-muted" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p class="text-muted">No comments yet. Be the first to add a comment!</p>
                    </div>
                    {% endfor %}

                    <!-- Add Comment Form - Only for Chairman, NOT for Secretary -->
                    {% if comment_form and user.role != 'secretary' %}
                    <div class="comment-form">
                        <h6 class="mb-3">
                            <i class="fas fa-plus-circle"></i>
                            Add Comment
                        </h6>
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ comment_form.comment|attr:"class:form-control"|attr:"rows:4"|attr:"placeholder:Enter your comment here..." }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ comment_form.attachment.id_for_label }}" class="form-label">
                                    <i class="fas fa-paperclip"></i>
                                    Attach File (Optional)
                                </label>
                                {{ comment_form.attachment|attr:"class:form-control"|attr:"accept:image/*,application/pdf,.doc,.docx" }}
                                <div class="form-text">
                                    Attach proof, documents, or images. Max size: 10MB
                                </div>
                            </div>
                            {% if user.can_manage_complaints %}
                            <div class="mb-3 form-check">
                                {{ comment_form.is_internal|attr:"class:form-check-input" }}
                                <label class="form-check-label" for="{{ comment_form.is_internal.id_for_label }}">
                                    <i class="fas fa-lock"></i>
                                    Internal comment (not visible to complainant)
                                </label>
                            </div>
                            {% endif %}
                            <button type="submit" class="btn-workflow btn-primary">
                                <i class="fas fa-paper-plane"></i>
                                Add Comment
                            </button>
                        </form>
                    </div>
                    {% elif user.role == 'secretary' %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> As Secretary, you can view complaints but only the Chairman has permission to add comments and attachments.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Stats -->
            <div class="sidebar-card fade-in">
                <div class="sidebar-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i>
                        Quick Stats
                    </h5>
                </div>
                <div class="sidebar-body">
                    <div class="info-grid">
                        <div class="info-item text-center">
                            <div class="info-label">Comments</div>
                            <div class="info-value">{{ comments.count }}</div>
                        </div>
                        <div class="info-item text-center">
                            <div class="info-label">Attachments</div>
                            <div class="info-value">{{ attachments.count }}</div>
                        </div>
                        <div class="info-item text-center">
                            <div class="info-label">Days Open</div>
                            <div class="info-value">{{ complaint.created_at|timesince }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Actions - Only for Secretary, Chairman, and Admin -->
            {% if user.can_manage_complaints and user.role in 'secretary,chairman' or user.is_superuser %}
            <div class="sidebar-card fade-in">
                <div class="sidebar-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i>
                        Workflow Actions
                    </h5>
                </div>
                <div class="sidebar-body">
                    <div class="workflow-actions">
                        <!-- Manual Update button only for Chairman and Admin, NOT for Secretary -->
                        {% if user.role == 'chairman' or user.is_superuser %}
                            <a href="{% url 'complaints:update_complaint' complaint.id %}" class="btn-workflow btn-outline-primary">
                                <i class="fas fa-edit"></i> Manual Update
                            </a>
                        {% endif %}
                        
                        <!-- Workflow-specific buttons based on status -->
                        {% if complaint.status == 'pending' %}
                            {% if user.is_chairman %}
                                <button type="button" class="btn-workflow btn-primary accept-complaint-btn" 
                                        data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                                    <i class="fas fa-thumbs-up"></i> Accept Complaint
                                </button>
                            {% endif %}
                        {% elif complaint.status == 'in_progress' %}
                            {% if user.role == 'chairman' or user.is_superuser %}
                                <button type="button" class="btn-workflow btn-success mark-resolved-btn" 
                                        data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                                    <i class="fas fa-check"></i> Mark Resolved
                                </button>
                            {% endif %}
                        {% elif complaint.status == 'resolved' %}
                            {% if user.role == 'chairman' or user.is_superuser %}
                                <button type="button" class="btn-workflow btn-warning close-complaint-btn" 
                                        data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                                    <i class="fas fa-times-circle"></i> Close Complaint
                                </button>
                            {% endif %}
                        {% elif complaint.status == 'closed' %}
                            {% if user.role == 'chairman' or user.is_superuser %}
                                <button type="button" class="btn-workflow btn-danger delete-btn" 
                                        data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                                    <i class="fas fa-trash"></i> Delete Complaint
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- Workflow Guide -->
                    <div class="workflow-guide">
                        <small class="text-muted">
                            <strong>Workflow:</strong>
                        </small>
                        <div class="workflow-steps">
                            <span class="workflow-step bg-secondary text-white">Pending</span>
                            <span class="workflow-arrow">→</span>
                            <span class="workflow-step bg-primary text-white">In Progress</span>
                            <span class="workflow-arrow">→</span>
                            <span class="workflow-step bg-success text-white">Resolved</span>
                            <span class="workflow-arrow">→</span>
                            <span class="workflow-step bg-warning text-dark">Closed</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper function to show success messages
    function showSuccessMessage(message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.page-header'));
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Helper function to update status display and workflow buttons
    function updateStatusDisplay(newStatus) {
        const statusBadge = document.querySelector('.status-badge');
        if (statusBadge) {
            // Remove old status classes
            statusBadge.classList.remove('status-pending', 'status-in_progress', 'status-resolved', 'status-closed');
            // Add new status class
            statusBadge.classList.add(`status-${newStatus}`);
            
            // Update status text
            const statusMap = {
                'pending': 'Pending',
                'in_progress': 'In Progress', 
                'resolved': 'Resolved',
                'closed': 'Closed'
            };
            statusBadge.textContent = statusMap[newStatus] || newStatus;
        }
        
        // Update workflow buttons based on new status
        const workflowActions = document.querySelector('.workflow-actions');
        if (workflowActions) {
            let buttonsHTML = `
                <!-- Always show Manual Update button -->
                <a href="/complaints/{{ complaint.id }}/update/" class="btn-workflow btn-outline-primary">
                    <i class="fas fa-edit"></i> Manual Update
                </a>
            `;
            
            if (newStatus === 'pending') {
                buttonsHTML += `
                    <button type="button" class="btn-workflow btn-primary accept-complaint-btn" 
                            data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                        <i class="fas fa-thumbs-up"></i> Accept Complaint
                    </button>
                `;
            } else if (newStatus === 'in_progress') {
                buttonsHTML += `
                    <button type="button" class="btn-workflow btn-success mark-resolved-btn" 
                            data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                        <i class="fas fa-check"></i> Mark Resolved
                    </button>
                `;
            } else if (newStatus === 'resolved') {
                buttonsHTML += `
                    <button type="button" class="btn-workflow btn-warning close-complaint-btn" 
                            data-complaint-id="{{ complaint.id }}" data-complaint-title="{{ complaint.title }}">
                        <i class="fas fa-times-circle"></i> Close Complaint
                    </button>
                `;
            } else if (newStatus === 'closed') {
                buttonsHTML += '<p class="text-muted"><i class="fas fa-check-circle"></i> Complaint completed</p>';
            }
            
            workflowActions.innerHTML = buttonsHTML;
            
            // Re-attach event listeners to new buttons
            attachEventListeners();
        }
    }

    // Function to attach event listeners (can be called multiple times)
    function attachEventListeners() {
        // Accept complaint functionality
        const acceptBtns = document.querySelectorAll('.accept-complaint-btn');
        acceptBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const complaintId = this.dataset.complaintId;
                const complaintTitle = this.dataset.complaintTitle;
                fetch(`/complaints/${complaintId}/accept/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage(data.message);
                        updateStatusDisplay(data.new_status);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while accepting the complaint.');
                });
            });
        });
        
        // Mark resolved functionality
        const resolvedBtns = document.querySelectorAll('.mark-resolved-btn');
        resolvedBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const complaintId = this.dataset.complaintId;
                const complaintTitle = this.dataset.complaintTitle;
                fetch(`/complaints/${complaintId}/mark-resolved/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage(data.message);
                        updateStatusDisplay(data.new_status);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while marking the complaint as resolved.');
                });
            });
        });
        
        // Close complaint functionality
        const closeBtns = document.querySelectorAll('.close-complaint-btn');
        closeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const complaintId = this.dataset.complaintId;
                const complaintTitle = this.dataset.complaintTitle;
                fetch(`/complaints/${complaintId}/close/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage(data.message);
                        updateStatusDisplay(data.new_status);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while closing the complaint.');
                });
            });
        });
        
        // Delete complaint functionality (still uses form submission)
        const deleteBtns = document.querySelectorAll('.delete-btn');
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const complaintId = this.dataset.complaintId;
                const complaintTitle = this.dataset.complaintTitle;
                
                // DIRECT DELETE - No confirmation dialog needed
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `{% url 'complaints:delete_complaint' complaint.id %}`;
                form.innerHTML = `{% csrf_token %}`;
                document.body.appendChild(form);
                form.submit();
            });
        });
    }

    // Initial attachment of event listeners
    attachEventListeners();
});

// Simple Image Viewer Function
function viewImage(imageUrl, imageName) {
    // Open image in a popup window
    const popup = window.open(imageUrl, 'imageViewer', 'width=800,height=600,scrollbars=yes,resizable=yes');
    if (popup) {
        popup.focus();
    } else {
        // Fallback if popup is blocked
        window.open(imageUrl, '_blank');
    }
}

// NO MORE JAVASCRIPT FOR REJECTION - Pure HTML approach!
// This eliminates ALL potential freezing issues

// Form is now controlled entirely by URL parameters
// No JavaScript = No conflicts = No freezing!

</script>

<!-- No more modal - Using pure HTML URL-based form instead! -->

{% endblock %}